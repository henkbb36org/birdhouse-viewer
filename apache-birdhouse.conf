# Apache Virtual Host Configuration for Birdhouse Viewer
# 
# Installation:
#   1. Copy this file to /etc/apache2/sites-available/birdhouse.conf
#   2. Edit ServerName and ServerAlias to match your domain
#   3. Enable required modules: sudo a2enmod proxy proxy_http proxy_wstunnel rewrite
#   4. Enable the site: sudo a2ensite birdhouse.conf
#   5. Reload Apache: sudo systemctl reload apache2
#
# For SSL/TLS:
#   Run: sudo certbot --apache -d your-domain.com

<VirtualHost *:8080>
    # Server configuration
    ServerName nt2500.bb36.org
    ServerAlias nt2500.bb36.org
    ServerAdmin henk@bb36.org

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/birdhouse-error.log
    CustomLog ${APACHE_LOG_DIR}/birdhouse-access.log combined
    LogLevel warn

    # Proxy settings
    ProxyPreserveHost On
    ProxyRequests Off

    # WebSocket support for real-time features
    RewriteEngine On
    
    # Upgrade WebSocket connections
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://localhost:3000/$1 [P,L]
    
    # Regular HTTP requests
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)           http://localhost:3000/$1 [P,L]

    # Proxy all requests to Node.js backend
    ProxyPass / http://localhost:3000/
    ProxyPassReverse / http://localhost:3000/

    # Proxy timeout settings (important for long-running connections)
    ProxyTimeout 300
    
    # Additional proxy settings for WebSocket
    <Proxy *>
        Order deny,allow
        Allow from all
    </Proxy>

    # Security headers (optional but recommended)
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
</VirtualHost>

# SSL Configuration (uncomment after running certbot)
# <IfModule mod_ssl.c>
# <VirtualHost *:443>
#     ServerName your-domain.com
#     ServerAlias www.your-domain.com
#     ServerAdmin admin@your-domain.com
#
#     # SSL Configuration (managed by Certbot)
#     SSLEngine on
#     SSLCertificateFile /etc/letsencrypt/live/your-domain.com/fullchain.pem
#     SSLCertificateKeyFile /etc/letsencrypt/live/your-domain.com/privkey.pem
#     Include /etc/letsencrypt/options-ssl-apache.conf
#
#     # Logging
#     ErrorLog ${APACHE_LOG_DIR}/birdhouse-ssl-error.log
#     CustomLog ${APACHE_LOG_DIR}/birdhouse-ssl-access.log combined
#
#     # Proxy settings (same as HTTP)
#     ProxyPreserveHost On
#     ProxyRequests Off
#
#     RewriteEngine On
#     RewriteCond %{HTTP:Upgrade} =websocket [NC]
#     RewriteRule /(.*)           ws://localhost:3000/$1 [P,L]
#     RewriteCond %{HTTP:Upgrade} !=websocket [NC]
#     RewriteRule /(.*)           http://localhost:3000/$1 [P,L]
#
#     ProxyPass / http://localhost:3000/
#     ProxyPassReverse / http://localhost:3000/
#     ProxyTimeout 300
#
#     # Security headers
#     Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
#     Header always set X-Frame-Options "SAMEORIGIN"
#     Header always set X-Content-Type-Options "nosniff"
#     Header always set X-XSS-Protection "1; mode=block"
# </VirtualHost>
# </IfModule>
